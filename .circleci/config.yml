version: 2.1

orbs:
  node: circleci/node@5.1.0
  python: circleci/python@2.1.1
  aws-eks: circleci/aws-eks@2.2.0
  kubernetes: circleci/kubernetes@1.3.1
  docker: circleci/docker@2.2.0
  sonarcloud: sonarsource/sonarcloud@2.0.0

executors:
  node-executor:
    docker:
      - image: cimg/node:18.19
    resource_class: medium
    working_directory: ~/repo

  python-executor:
    docker:
      - image: cimg/python:3.10
    resource_class: medium
    working_directory: ~/repo

  deployment-executor:
    docker:
      - image: cimg/base:2024.01
    resource_class: medium
    working_directory: ~/repo

commands:
  install-kubectl:
    steps:
      - run:
          name: Install kubectl
          command: |
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/

  install-helm:
    steps:
      - run:
          name: Install Helm
          command: |
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

  setup-aws-credentials:
    steps:
      - run:
          name: Configure AWS credentials
          command: |
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
            aws configure set region $AWS_REGION

jobs:
  checkout-code:
    executor: node-executor
    steps:
      - checkout
      - persist_to_workspace:
          root: ~/repo
          paths:
            - .

  install-dependencies:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - node-deps-v1-{{ checksum "package-lock.json" }}
            - node-deps-v1-
      - run:
          name: Install root dependencies
          command: npm ci
      - run:
          name: Install frontend dependencies
          command: cd frontend && npm ci
      - run:
          name: Install backend dependencies
          command: cd backend && npm ci
      - save_cache:
          key: node-deps-v1-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
            - frontend/node_modules
            - backend/node_modules
      - persist_to_workspace:
          root: ~/repo
          paths:
            - node_modules
            - frontend/node_modules
            - backend/node_modules

  install-python-dependencies:
    executor: python-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - python-deps-v1-{{ checksum "ai_ml/requirements.txt" }}
            - python-deps-v1-
      - run:
          name: Install AI/ML dependencies
          command: |
            cd ai_ml
            pip install -r requirements.txt
      - save_cache:
          key: python-deps-v1-{{ checksum "ai_ml/requirements.txt" }}
          paths:
            - ~/.cache/pip
      - persist_to_workspace:
          root: ~/repo
          paths:
            - ai_ml

  lint:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Run linter
          command: npm run lint

  test-frontend:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Run frontend tests
          command: |
            cd frontend
            npm run test -- --coverage --watchAll=false
      - store_test_results:
          path: frontend/test-results
      - store_artifacts:
          path: frontend/coverage
          destination: frontend-coverage
      - persist_to_workspace:
          root: ~/repo
          paths:
            - frontend/coverage

  test-backend:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Run backend tests
          command: |
            cd backend
            npm run test -- --coverage
      - store_test_results:
          path: backend/test-results
      - store_artifacts:
          path: backend/coverage
          destination: backend-coverage
      - persist_to_workspace:
          root: ~/repo
          paths:
            - backend/coverage

  test-ai-ml:
    executor: python-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Run AI/ML tests
          command: |
            cd ai_ml
            pip install pytest pytest-cov
            pytest --cov=. --cov-report=xml --cov-report=html
      - store_test_results:
          path: ai_ml/test-results
      - store_artifacts:
          path: ai_ml/htmlcov
          destination: ai-ml-coverage

  build-frontend:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Build frontend
          command: |
            cd frontend
            npm run build
      - persist_to_workspace:
          root: ~/repo
          paths:
            - frontend/build

  security-scan:
    executor: node-executor
    docker:
      - image: aquasec/trivy:latest
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Run Trivy security scan
          command: |
            trivy fs --security-checks vuln,config frontend/
            trivy fs --security-checks vuln,config backend/
            trivy fs --format json --output trivy-report.json .
      - store_artifacts:
          path: trivy-report.json
          destination: security-reports

  sonarqube-analysis:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - sonarcloud/scan

  build-docker-images:
    executor: docker/docker
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: ~/repo
      - run:
          name: Build and push Docker images
          command: |
            echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin

            # Build frontend
            docker build -t $DOCKER_REGISTRY/docuthinker-frontend:$CIRCLE_SHA1 \
                         -t $DOCKER_REGISTRY/docuthinker-frontend:latest \
                         frontend/

            # Build backend
            docker build -t $DOCKER_REGISTRY/docuthinker-backend:$CIRCLE_SHA1 \
                         -t $DOCKER_REGISTRY/docuthinker-backend:latest \
                         backend/

            # Push images
            docker push $DOCKER_REGISTRY/docuthinker-frontend:$CIRCLE_SHA1
            docker push $DOCKER_REGISTRY/docuthinker-frontend:latest
            docker push $DOCKER_REGISTRY/docuthinker-backend:$CIRCLE_SHA1
            docker push $DOCKER_REGISTRY/docuthinker-backend:latest

  deploy-dev:
    executor: deployment-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - install-kubectl
      - install-helm
      - setup-aws-credentials
      - run:
          name: Update kubeconfig
          command: |
            aws eks update-kubeconfig --name docuthinker-dev --region $AWS_REGION
      - run:
          name: Deploy to development
          command: |
            kubectl set image deployment/frontend frontend=$DOCKER_REGISTRY/docuthinker-frontend:$CIRCLE_SHA1 -n docuthinker-dev
            kubectl set image deployment/backend backend=$DOCKER_REGISTRY/docuthinker-backend:$CIRCLE_SHA1 -n docuthinker-dev
            kubectl rollout status deployment/frontend -n docuthinker-dev --timeout=5m
            kubectl rollout status deployment/backend -n docuthinker-dev --timeout=5m

  deploy-staging:
    executor: deployment-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - install-kubectl
      - install-helm
      - setup-aws-credentials
      - run:
          name: Update kubeconfig
          command: |
            aws eks update-kubeconfig --name docuthinker-staging --region $AWS_REGION
      - run:
          name: Deploy to staging
          command: |
            kubectl set image deployment/frontend frontend=$DOCKER_REGISTRY/docuthinker-frontend:$CIRCLE_SHA1 -n docuthinker-staging
            kubectl set image deployment/backend backend=$DOCKER_REGISTRY/docuthinker-backend:$CIRCLE_SHA1 -n docuthinker-staging
            kubectl rollout status deployment/frontend -n docuthinker-staging --timeout=5m
            kubectl rollout status deployment/backend -n docuthinker-staging --timeout=5m

  deploy-production-canary:
    executor: deployment-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - install-kubectl
      - install-helm
      - setup-aws-credentials
      - run:
          name: Update kubeconfig
          command: |
            aws eks update-kubeconfig --name docuthinker-prod --region $AWS_REGION
      - run:
          name: Deploy canary to production
          command: |
            kubectl set image deployment/backend-canary backend=$DOCKER_REGISTRY/docuthinker-backend:$CIRCLE_SHA1 -n docuthinker-prod
            kubectl set image deployment/frontend-canary frontend=$DOCKER_REGISTRY/docuthinker-frontend:$CIRCLE_SHA1 -n docuthinker-prod
            kubectl rollout status deployment/backend-canary -n docuthinker-prod --timeout=5m
            kubectl rollout status deployment/frontend-canary -n docuthinker-prod --timeout=5m

  promote-production:
    executor: deployment-executor
    steps:
      - attach_workspace:
          at: ~/repo
      - install-kubectl
      - install-helm
      - setup-aws-credentials
      - run:
          name: Update kubeconfig
          command: |
            aws eks update-kubeconfig --name docuthinker-prod --region $AWS_REGION
      - run:
          name: Promote to production
          command: |
            kubectl set image deployment/backend-blue backend=$DOCKER_REGISTRY/docuthinker-backend:$CIRCLE_SHA1 -n docuthinker-prod
            kubectl set image deployment/frontend-blue frontend=$DOCKER_REGISTRY/docuthinker-frontend:$CIRCLE_SHA1 -n docuthinker-prod
            kubectl rollout status deployment/backend-blue -n docuthinker-prod --timeout=5m
            kubectl rollout status deployment/frontend-blue -n docuthinker-prod --timeout=5m
            kubectl patch service backend-service -p '{"spec":{"selector":{"track":"blue"}}}' -n docuthinker-prod
            kubectl patch service frontend-service -p '{"spec":{"selector":{"track":"blue"}}}' -n docuthinker-prod

  smoke-test:
    executor: deployment-executor
    parameters:
      environment:
        type: string
      url:
        type: string
    steps:
      - run:
          name: Run smoke tests
          command: |
            sleep 30
            curl -f << parameters.url >>/health || exit 1
            curl -f << parameters.url >>/api/health || exit 1

  performance-test:
    executor: deployment-executor
    docker:
      - image: grafana/k6:latest
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Run performance tests
          command: |
            k6 run --vus 10 --duration 30s scripts/performance/load-test.js
      - store_artifacts:
          path: k6-results.json
          destination: performance-results

workflows:
  version: 2

  build-test-deploy:
    jobs:
      - checkout-code

      - install-dependencies:
          requires:
            - checkout-code

      - install-python-dependencies:
          requires:
            - checkout-code

      - lint:
          requires:
            - install-dependencies

      - test-frontend:
          requires:
            - install-dependencies

      - test-backend:
          requires:
            - install-dependencies

      - test-ai-ml:
          requires:
            - install-python-dependencies

      - build-frontend:
          requires:
            - test-frontend

      - security-scan:
          requires:
            - install-dependencies

      - sonarqube-analysis:
          requires:
            - test-frontend
            - test-backend

      - build-docker-images:
          requires:
            - build-frontend
            - test-backend
            - security-scan
          filters:
            branches:
              only:
                - develop
                - master

      - deploy-dev:
          requires:
            - build-docker-images
          filters:
            branches:
              only: develop

      - smoke-test:
          name: smoke-test-dev
          environment: dev
          url: https://dev.docuthinker.com
          requires:
            - deploy-dev

      - deploy-staging:
          requires:
            - build-docker-images
          filters:
            branches:
              only: master

      - smoke-test:
          name: smoke-test-staging
          environment: staging
          url: https://staging.docuthinker.com
          requires:
            - deploy-staging

      - performance-test:
          requires:
            - smoke-test-staging

      - hold-production:
          type: approval
          requires:
            - performance-test
          filters:
            branches:
              only: master

      - deploy-production-canary:
          requires:
            - hold-production

      - smoke-test:
          name: smoke-test-canary
          environment: production-canary
          url: https://canary.docuthinker.com
          requires:
            - deploy-production-canary

      - hold-promote:
          type: approval
          requires:
            - smoke-test-canary
          filters:
            branches:
              only: master

      - promote-production:
          requires:
            - hold-promote

      - smoke-test:
          name: smoke-test-production
          environment: production
          url: https://docuthinker.com
          requires:
            - promote-production
